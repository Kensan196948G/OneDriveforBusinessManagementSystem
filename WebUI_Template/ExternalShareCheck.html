<!DOCTYPE html>
<html>
<head>
<title>外部共有レポート</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body {
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.table thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
}
:root {
  --user-color: #64b5f6;
  --item-color: #ffd54f;
  --external-color: #ef5350;
  --date-color: #4dd0e1;
  --action-color: #66bb6a;
}

.column-user { 
  background: linear-gradient(135deg, var(--user-color), #42a5f5);
  color: white;
}
.column-item { 
  background: linear-gradient(135deg, var(--item-color), #ffca28);
  color: #333;
}
.column-external { 
  background: linear-gradient(135deg, var(--external-color), #e53935);
  color: white;
}
.column-date { 
  background: linear-gradient(135deg, var(--date-color), #26c6da);
  color: white;
}
.column-action { 
  background: linear-gradient(135deg, var(--action-color), #43a047);
  color: white;
}

.status-alert { 
  background: linear-gradient(135deg, #ff5252, #c62828);
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.status-warning { 
  background: linear-gradient(135deg, #ffd740, #ffa000);
  color: #333;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.status-normal { 
  background: linear-gradient(135deg, #69f0ae, #00c853);
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.table-hover tbody tr:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}
.filter-row select {
    width: 100%;
    padding: 5px;
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}
.filter-container {
    background-color: #f5f5f5;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    display: none;
}
.loading-spinner {
    color: white;
    font-size: 2rem;
}
.error-message {
    color: #dc3545;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    display: none;
}
.pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 20px;
}
</style>
</head>
<body>
<div class="container">
    <h1 class="text-center mb-4">
      <i class="fas fa-user-shield me-3 text-primary"></i>
      外部共有レポート
      <i class="fas fa-external-link-alt ms-3 text-danger"></i>
    </h1>
    
    <div id="errorContainer" class="error-message">
        <h4><i class="fas fa-exclamation-triangle me-2"></i>外部共有データ取得エラー</h4>
        <p>外部共有データの取得に失敗しました。以下の手順で確認してください:</p>
        <ol>
            <li>PowerShellスクリプト <code>ExternalShareCheck.ps1</code> が正しく実行できるか確認</li>
            <li>必要な権限があるか確認</li>
            <li>ネットワーク接続を確認</li>
        </ol>
        <button class="btn btn-danger mt-2" onclick="loadData()">
            <i class="fas fa-sync-alt me-1"></i>再試行
        </button>
    </div>

    <div class="filter-container">
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="globalSearch" placeholder="ユーザー名またはファイル名で検索..." onkeyup="filterTable()">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-danger me-2" onclick="exportToCsv()">
                    <i class="fas fa-file-export me-1"></i>CSVエクスポート
                </button>
                <button class="btn btn-primary me-2" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>印刷
                </button>
                <button class="btn btn-warning" onclick="loadData()">
                    <i class="fas fa-sync-alt me-1"></i>更新
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="externalShareTable">
            <thead>
                <tr>
                    <th class="column-user">
                      <i class="fas fa-user-shield me-2"></i>
                      <span class="badge bg-white text-dark">所有者</span>
                    </th>
            <div class="row mb-3">
                <div class="col-md-3 text-center">
                    <span id="resultCount" class="badge bg-info text-dark">0件中 0～0件を表示</span>
                </div>
                <div class="col-md-9 text-end">
                    <div class="input-group">
                        <input type="text" id="globalSearch" class="form-control" placeholder="全体検索...">
                        <button class="btn btn-outline-secondary" type="button" onclick="filterTable()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                    <th class="column-item">
                      <i class="fas fa-file-contract me-2"></i>
                      <span class="badge bg-white text-dark">共有アイテム</span>
                    </th>
                    <th class="column-external">
                      <i class="fas fa-globe-americas me-2"></i>
                      <span class="badge bg-white text-dark">外部共有先</span>
                    </th>
                    <th class="column-date">
                      <i class="fas fa-calendar-check me-2"></i>
                      <span class="badge bg-white text-dark">共有日</span>
                    </th>
                    <th class="column-action">
                      <i class="fas fa-tasks me-2"></i>
                      <span class="badge bg-white text-dark">推奨アクション</span>
                    </th>
                </tr>
                <tr class="filter-row">
                    <th><select class="form-select" onchange="filterTable()"></select></th>
                    <th><select class="form-select" onchange="filterTable()"></select></th>
                    <th><select class="form-select" onchange="filterTable()"></select></th>
                    <th><select class="form-select" onchange="filterTable()"></select></th>
                    <th><select class="form-select" onchange="filterTable()"></select></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination" id="pagination">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">前へ</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">次へ</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> 外部共有データを取得中...
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ページネーション設定
const itemsPerPage = 10;
let currentPage = 1;

// データ取得
function loadData() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('errorContainer').style.display = 'none';
    
    // 実際にはここでAPI呼び出しやCSV読み込みを行う
    setTimeout(() => {
        try {
            // サンプルデータ（実際にはCSVから読み込まれる）
            window.shareData = [
                {
                    "所有者": "山田 太郎",
                    "共有アイテム": "/機密資料/契約書.pdf",
                    "外部共有先": "partner@external.com (編集権限)",
                    "共有日": "2025/04/10",
                    "推奨アクション": "即時対応が必要"
                },
                {
                    "所有者": "佐藤 花子",
                    "共有アイテム": "/プロジェクト/仕様書.docx",
                    "外部共有先": "client@example.com (表示権限)",
                    "共有日": "2025/04/12",
                    "推奨アクション": "確認推奨"
                },
                {
                    "所有者": "鈴木 一郎",
                    "共有アイテム": "/公開資料/製品紹介.pptx",
                    "外部共有先": "public@sample.com (表示権限)",
                    "共有日": "2025/04/15",
                    "推奨アクション": "問題なし"
                },
                {
                    "所有者": "田中 健太",
                    "共有アイテム": "/財務/決算報告.xlsx",
                    "外部共有先": "accounting@vendor.com (編集権限)",
                    "共有日": "2025/04/08",
                    "推奨アクション": "即時対応が必要"
                },
                {
                    "所有者": "高橋 裕子",
                    "共有アイテム": "/マニュアル/操作手順.pdf",
                    "外部共有先": "support@partner.com (表示権限)",
                    "共有日": "2025/04/14",
                    "推奨アクション": "確認推奨"
                },
                {
                    "所有者": "伊藤 正",
                    "共有アイテム": "/マーケティング/リリースノート.docx",
                    "外部共有先": "press@media.com (表示権限)",
                    "共有日": "2025/04/16",
                    "推奨アクション": "問題なし"
                },
                {
                    "所有者": "渡辺 美咲",
                    "共有アイテム": "/人事/評価表.xlsx",
                    "外部共有先": "consultant@hr.com (編集権限)",
                    "共有日": "2025/04/05",
                    "推奨アクション": "即時対応が必要"
                },
                {
                    "所有者": "中村 隆",
                    "共有アイテム": "/設計/図面.dwg",
                    "外部共有先": "engineer@contractor.com (表示権限)",
                    "共有日": "2025/04/11",
                    "推奨アクション": "確認推奨"
                },
                {
                    "所有者": "小林 翔子",
                    "共有アイテム": "/広報/プレスリリース.docx",
                    "外部共有先": "news@press.com (表示権限)",
                    "共有日": "2025/04/17",
                    "推奨アクション": "問題なし"
                },
                {
                    "所有者": "加藤 大輔",
                    "共有アイテム": "/研究/特許資料.pdf",
                    "外部共有先": "lawyer@firm.com (編集権限)",
                    "共有日": "2025/04/09",
                    "推奨アクション": "即時対応が必要"
                },
                {
                    "所有者": "吉田 翔",
                    "共有アイテム": "/開発/ソースコード.zip",
                    "外部共有先": "dev@outsource.com (編集権限)",
                    "共有日": "2025/04/13",
                    "推奨アクション": "即時対応が必要"
                },
                {
                    "所有者": "山本 美咲",
                    "共有アイテム": "/営業/顧客リスト.xlsx",
                    "外部共有先": "sales@partner.com (表示権限)",
                    "共有日": "2025/04/07",
                    "推奨アクション": "確認推奨"
                },
                {
                    "所有者": "中島 健",
                    "共有アイテム": "/管理/パスワードリスト.txt",
                    "外部共有先": "admin@vendor.com (編集権限)",
                    "共有日": "2025/04/04",
                    "推奨アクション": "即時対応が必要"
                },
                {
                    "所有者": "佐々木 良子",
                    "共有アイテム": "/教育/トレーニング資料.pdf",
                    "外部共有先": "trainer@consultant.com (表示権限)",
                    "共有日": "2025/04/18",
                    "推奨アクション": "問題なし"
                },
                {
                    "所有者": "井上 拓也",
                    "共有アイテム": "/会議/戦略資料.pptx",
                    "外部共有先": "board@investor.com (表示権限)",
                    "共有日": "2025/04/19",
                    "推奨アクション": "確認推奨"
                }
            ];
            
            initFilters();
            renderTable();
            setupPagination();
            document.getElementById('loadingOverlay').style.display = 'none';
        } catch (error) {
            console.error('外部共有データ取得エラー:', error);
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
        }
    }, 1500);
}

// フィルターメニュー初期化
function initFilters() {
    const columns = ['所有者', '共有アイテム', '外部共有先', '推奨アクション'];
    
    columns.forEach((col, index) => {
        const select = document.querySelectorAll('.filter-row select')[index];
        const uniqueValues = [...new Set(window.shareData.map(item => item[col]))];
        
        // デフォルトオプション
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = `すべての${col}`;
        select.appendChild(defaultOption);
        
        // ユニークな値を追加
        uniqueValues.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        });
    });
}

// テーブルデータ表示
function renderTable() {
    const tbody = document.querySelector('#externalShareTable tbody');
    tbody.innerHTML = '';
    
    const filteredData = applyFilters(window.shareData, ['所有者', '共有アイテム', '外部共有先', '共有日', '推奨アクション']);
    const paginatedData = filteredData.slice(
        (currentPage - 1) * itemsPerPage,
        currentPage * itemsPerPage
    );
    
    paginatedData.forEach(item => {
        const row = document.createElement('tr');
        const statusClass = {
            '即時対応が必要': 'status-alert',
            '確認推奨': 'status-warning',
            '問題なし': 'status-normal'
        }[item['推奨アクション']] || '';
        
        row.className = statusClass;
        
        row.innerHTML = `
            <td>${item['所有者']}</td>
            <td>${item['共有アイテム']}</td>
            <td>${item['外部共有先']}</td>
            <td>${item['共有日']}</td>
            <td>${item['推奨アクション']}</td>
        `;
        
        tbody.appendChild(row);
    });
}
// ページネーション設定
function setupPagination() {
    const filteredData = applyFilters(window.externalShareData, ['ユーザー名', '共有アイテム', '権限', '外部共有先', '共有日', '推奨アクション']);
    const pageCount = Math.ceil(filteredData.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    // 前へボタン
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">前へ</a>`;
    pagination.appendChild(prevItem);

    // ページ番号
    for (let i = 1; i <= pageCount; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(pageItem);
    }

    // 次へボタン
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
    nextItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">次へ</a>`;
    pagination.appendChild(nextItem);
}

// ページ変更
function changePage(page) {
    currentPage = page;
    renderTable();
    setupPagination();
}

// CSVエクスポート
function exportToCsv() {
    const headers = ['所有者', '共有アイテム', '外部共有先', '共有日', '推奨アクション'].join(',') + '\n';
    const csvContent = headers + window.shareData.map(item => 
        ['所有者', '共有アイテム', '外部共有先', '共有日', '推奨アクション']
        .map(col => `"${item[col]}"`).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'ExternalShareReport.csv');
    link.click();
}

// フィルター適用
function filterTable() {
    currentPage = 1;
    renderTable();
    setupPagination();
}

// 初期化
window.onload = function() {
    loadData();
    
    document.getElementById('globalSearch').addEventListener('keyup', filterTable);
    document.querySelectorAll('.filter-row select').forEach(select => {
        select.addEventListener('change', filterTable);
    });
};
</script>
</body>
</html>